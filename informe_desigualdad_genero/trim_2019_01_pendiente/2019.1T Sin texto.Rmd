---
title: "La desigualdad de género se puede medir"
subtitle: "Datos de la Encuesta Permanente de Hogares. 1er trimestre de 2019."
author: "Natsumi S. Shokida (@NatsuSh)^[ _Economista (FCE-UBA). Me dedico al análisis de datos. Formo parte de_ [Economía Femini(s)ta](http://economiafeminita.com/) _y_ [RLadies Buenos Aires](https://www.meetup.com/es/rladies-buenos-aires/). _Contacto_: natsumi.shokida@gmail.com]"
date: "Noviembre de 2019"
output: 
  html_notebook:
    toc: true
    toc_float: true
    depth: 5
---
     
## Introducción

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Se limpia la memoria y se cargan librerías útiles
# Reiniciar R
library(tidyverse)
library(httr)
library(stringr)
library(ggthemes)
library(scales)
library(knitr)
library(ggalt)
library(kableExtra)
library(formattable)
library(eph)
library(openxlsx)
library(gridExtra)
library(magrittr)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
date <- "1er trimestre 2019"
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Funciones útiles

# Funciones de redondeo y presentación (quedan como character)
formato_porc <- function(numero, dec = 1){
  format(round(numero, digits = dec), nsmall = dec, decimal.mark = ",")
}

formato_pesos <- function(numero, dec = 2){
  paste0("$", format(round(numero, digits = dec), nsmall = dec, big.mark = ".", decimal.mark = ","))
}

formato_cantidad <- function(numero, dec = 0){
  format(round(numero, digits = dec), nsmall = dec, big.mark = ".", decimal.mark = ",")
}

```

```{r message=FALSE, warning=FALSE, include=FALSE}
# Se levantan las bases usuarias de la EPH del trimestre correspondiente
# (funciones del paquete 'eph')
base_individual <- get_microdata(year = 2019, trimester = 1, type = "individual")
base_hogar <- get_microdata(year = 2019, trimester = 1, type = "hogar")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Modificaciones en la base
base_individual <- base_individual %>% 
  mutate(Sexo = as.character(CH04),
         Sexo = case_when(Sexo=="1" ~ "Varones",
                          Sexo=="2" ~ "Mujeres"),
         PP04D_COD = as.character(PP04D_COD),
         PP04D_COD = case_when(nchar(PP04D_COD) == 5 ~ PP04D_COD,
                               nchar(PP04D_COD) == 4 ~ paste0("0", PP04D_COD),
                               nchar(PP04D_COD) == 3 ~ paste0("00", PP04D_COD),
                               nchar(PP04D_COD) == 2 ~ paste0("000", PP04D_COD),
                               nchar(PP04D_COD) == 1 ~ paste0("0000", PP04D_COD)),
         CALIFICACION = substr(PP04D_COD, 5, 5),
         CALIFICACION = case_when(CALIFICACION=="1" ~ "Profesionales",
                                  CALIFICACION=="2" ~ "Técnicos",
                                  CALIFICACION=="3" ~ "Operativos",
                                  CALIFICACION=="4" ~ "No Calificados",
                                  TRUE ~ "0"),
         CALIFICACION = factor(CALIFICACION, c("No Calificados", "Operativos", "Técnicos", "Profesionales")),
         JERARQUIA = substr(PP04D_COD, 3, 3),
         JERARQUIA = case_when(JERARQUIA %in% c("0", "2") ~ "Dirección o Jefes",
                               JERARQUIA=="1" ~ "Cuentapropia",
                               JERARQUIA=="3" ~ "Trabajadores Asalariados",
                               TRUE ~ "0"),
         JERARQUIA = factor(JERARQUIA, c("Dirección o Jefes", "Trabajadores Asalariados", "Cuentapropia")),
         NIVEL_EDUCATIVO = case_when(NIVEL_ED %in% c(1, 7) ~ "Sin Instrucción",
                                     NIVEL_ED %in% c(2, 3) ~ "Primaria",
                                     NIVEL_ED %in% c(4, 5) ~ "Secundaria",
                                     NIVEL_ED == 6         ~ "Superior",
                                     NIVEL_ED == 9         ~ "NS/NR"),
         NIVEL_EDUCATIVO = factor(NIVEL_EDUCATIVO, levels = c("Sin Instrucción", "Primaria", "Secundaria", "Superior")),
         GRUPO_EDAD = case_when(CH06 >= 14 & CH06 <= 29 ~ "de 14 a 29 años",
                                CH06 >= 30 & CH06 <= 64 ~ "de 30 a 64 años"))

# colores = c("#aa165a","#16aa66")
colores = c("#FE1764", "#00BDD6")
```

## Composición del Mercado de Trabajo

### Tasas básicas

<br>

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla1.1 <- base_individual %>% 
  filter(CH06 >= 14) %>% 
  group_by(Sexo) %>% 
  summarise(Poblacion         = sum(PONDERA),
            Ocupados          = sum(PONDERA[ESTADO == 1]),
            Desocupados       = sum(PONDERA[ESTADO == 2]),
            PEA               = Ocupados + Desocupados,
            Ocupados_demand   = sum(PONDERA[ESTADO == 1 & PP03J ==1]),
            Suboc_demandante  = sum(PONDERA[ESTADO == 1 & INTENSI ==1 & PP03J==1]),
            Suboc_no_demand   = sum(PONDERA[ESTADO == 1 & INTENSI ==1 & PP03J %in% c(2,9)]),
            Subocupados       = Suboc_demandante + Suboc_no_demand,
            'Tasa Actividad'                  = round(PEA/Poblacion, 3),
            'Tasa Empleo'                     = round(Ocupados/Poblacion, 3),
            'Tasa Desocupación'               = round(Desocupados/PEA, 3),
            'Tasa Ocupados Demandantes'       = round(Ocupados_demand/PEA, 3),
            'Tasa Subocupación'               = round(Subocupados/PEA, 3),
            'Tasa Subocupación demandante'    = round(Suboc_demandante/PEA, 3),
            'Tasa Subocupación no demandante' = round(Suboc_no_demand/PEA, 3)) %>% 
  select(-c(2:9)) %>% 
  gather(Indicadores, Valor, 2:8) %>% 
  spread(., Sexo, Valor)
```

__Gráfico 1.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
tabla1.2_graf <- tabla1.1 %>% 
  filter(Indicadores %in% c("Tasa Actividad", "Tasa Empleo")) %>% 
  gather(., Sexo, proporcion, 2:3)

ggplot(tabla1.2_graf, aes(x = '', proporcion, fill = Sexo, group = Sexo, 
                          label = paste0(formato_porc(proporcion*100), "%"))) +
  geom_col(position = "dodge") +
  geom_text(position = position_dodge(width = .9), vjust =2, size = 6) +
  scale_fill_manual(values = colores) +
  facet_wrap(~Indicadores, strip.position = "bottom") +
  labs(title = "Tasas de Actividad y de Empleo por sexo",
       subtitle = paste0("Población de 14 años y más. Total de aglomerados urbanos. ", date),
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC") +
  theme_minimal() +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank())
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Aquí hay que cambiar el directorio en que se va a guardar el gráfico.
ggsave("Grafico1.png", scale = 0.7, dpi = 300, width = 10, height = 7)
```

__Gráfico 2.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
tabla1.3_graf <- tabla1.1 %>% 
  filter(Indicadores %in% c("Tasa Desocupación", "Tasa Subocupación")) %>% 
  gather(., Sexo, proporcion, 2:3)

ggplot(tabla1.3_graf, aes(x = '', proporcion, fill = Sexo, group = Sexo, 
                          label = paste0(formato_porc(proporcion*100), "%"))) +
  geom_col(position = "dodge") +
  geom_text(position = position_dodge(width = .9), vjust =2, size = 6) +
  scale_fill_manual(values = colores) +
  facet_wrap(~Indicadores, strip.position = "bottom") +
  labs(title = "Tasas de Desocupación y de Subocupación por sexo",
       subtitle = paste0("Población de 14 años y más. Total de aglomerados urbanos. ", date),
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC") +
  theme_minimal() +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank())
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Aquí hay que cambiar el directorio en que se va a guardar el gráfico.
ggsave("Grafico2.png", scale = 0.7, dpi = 300, width = 10, height = 7)
```

### Por grupos de edad y sexo

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla1.4 <- base_individual %>% 
  filter(CH06 >= 14) %>% 
  group_by(Sexo, GRUPO_EDAD) %>% 
  summarise(Poblacion         = sum(PONDERA),
            Ocupados          = sum(PONDERA[ESTADO == 1]),
            Desocupados       = sum(PONDERA[ESTADO == 2]),
            PEA               = Ocupados + Desocupados,
            Ocupados_demand   = sum(PONDERA[ESTADO == 1 & PP03J ==1]),
            Suboc_demandante  = sum(PONDERA[ESTADO == 1 & INTENSI ==1 & PP03J==1]),
            Suboc_no_demand   = sum(PONDERA[ESTADO == 1 & INTENSI ==1 & PP03J %in% c(2,9)]),
            Subocupados       = Suboc_demandante + Suboc_no_demand,
            'Tasa Actividad'                  = percent(PEA/Poblacion, 1),
            'Tasa Empleo'                     = percent(Ocupados/Poblacion, 1),
            'Tasa Desocupación'               = percent(Desocupados/PEA, 1),
            'Tasa Subocupación'               = percent(Subocupados/PEA, 1)) %>% 
  select(-c(3:10)) %>% 
  filter(!is.na(GRUPO_EDAD)) %>% 
  gather(Indicadores, Valor, 3:6) %>% 
  spread(., Sexo, Valor) %>% 
  mutate(Indicadores = factor(Indicadores, levels = c("Tasa Actividad", "Tasa Empleo", "Tasa Desocupación", "Tasa Subocupación"))) %>% 
  arrange(Indicadores)

tabla1.4.m <- tabla1.4 %>% 
  select(-Varones) %>% 
  spread(., GRUPO_EDAD, Mujeres)

tabla1.4.v <- tabla1.4 %>% 
  select(-Mujeres) %>% 
  spread(., GRUPO_EDAD, Varones)

tabla1.5 <- left_join(tabla1.4.m, tabla1.4.v, by = "Indicadores") %>% 
  select(Indicadores, Mujeres = `de 14 a 29 años.x`, Varones = `de 14 a 29 años.y`,
         Mujeres = `de 30 a 64 años.x`, Varones = `de 30 a 64 años.y`)
```

__Cuadro 1.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
cuadro1 <- kable(tabla1.5,
      caption = paste("Principales Tasas del Mercado de Trabajo, por grupos de edad y sexo. Población de 14 a 64 años. Total de aglomerados urbanos. ", date)) %>%
  kable_styling(bootstrap_options = c("striped"), 
                full_width = F, position = "left") %>%
  add_header_above(c(" " = 1, "de 14 a 29 años" = 2, "de 30 a 64 años" = 2)) %>% 
  footnote(general = "Natsumi Shokida en base a EPH-INDEC",
           general_title = "Fuente: ",
           title_format = c("italic"),
           footnote_as_chunk = FALSE) %>%
  column_spec(1, width = "4cm") %>% 
  column_spec(2, bold = TRUE, width = "3cm") %>% 
  column_spec(3, width = "3cm") %>% 
  column_spec(4, width = "3cm") %>%
  column_spec(5, width = "3cm")
  
cuadro1
```

## Empleo no registrado

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla2.1 <- base_individual %>% 
  filter(ESTADO==1,
         CAT_OCUP==3) %>% 
  group_by(Sexo) %>% 
  summarise("Sin descuento jubilatorio" = percent(sum(PONDERA[PP07H==2])/sum(PONDERA), 1))
```

__Cuadro 2.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
cuadro2 <- kable(tabla2.1,
                 caption = paste("Empleo sin descuento jubilatorio por sexo. Ocupadas/os asalariadas/os. Total de aglomerados urbanos. ", date)) %>% 
  kable_styling(bootstrap_options = c("striped"), 
                full_width = F, position = "left") %>% 
  footnote(general = "Natsumi Shokida en base a EPH-INDEC",
           general_title = "Fuente: ",
           title_format = c("italic"),
           footnote_as_chunk = FALSE) %>% 
  column_spec(1, width = "5cm") %>% 
  column_spec(2, width = "7cm")

cuadro2
```

## Acceso a Cargos jerárquicos

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla3.1 <- base_individual %>% 
  filter(JERARQUIA != "0",
         ESTADO == 1) %>%
  group_by(Sexo) %>% 
  mutate(Frecuencia = sum(PONDERA)) %>% 
  group_by(Sexo, JERARQUIA) %>% 
  summarise(proporcion = round(sum(PONDERA)/unique(Frecuencia), 3),
            cantidad = sum(PONDERA))
```

__Gráfico 3.__       
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(tabla3.1 %>% filter(JERARQUIA == "Dirección o Jefes"), 
       aes(x = '', cantidad, fill = Sexo, group = Sexo, 
                          label = formato_cantidad(cantidad))) +
  geom_col(position = "dodge") +
  geom_text(position = position_dodge(width = .9), vjust =2, size = 6) +
  scale_fill_manual(values = colores) +
  labs(title = "Mujeres y Varones en cargos de dirección y jefatura.",
       subtitle = paste0("Ocupadas/os. Total de aglomerados urbanos. ", date),
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC") +
  theme_minimal() +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.y = element_blank())
```
       
```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Aquí hay que cambiar el directorio en que se va a guardar el gráfico.
ggsave("Grafico3.png", scale = 0.7, dpi = 300, width = 10, height = 7)
```

## Brechas de ingresos mensuales

```{r message=FALSE, warning=FALSE, include=FALSE}
# Ingreso Total Individual
tabla4.1.1 <- base_individual %>% 
  filter(P47T > 0) %>% 
  group_by(Sexo) %>% 
  summarise(Media.ITI = round(weighted.mean(P47T, PONDII))) %>% 
  spread(., Sexo, Media.ITI) %>% 
  mutate(Población = "Perceptores de ingresos",
         Ingreso = "Ingreso Total Individual")

# Ingreso de la Ocupación Principal
tabla4.1.2 <- base_individual %>% 
  filter(ESTADO == 1) %>% 
  group_by(Sexo) %>% 
  summarise(Media.IOP = round(weighted.mean(P21, PONDIIO))) %>% 
  spread(., Sexo, Media.IOP) %>% 
  mutate(Población = "Ocupadas/os",
         Ingreso = "Ingreso de la Ocupación Principal")

# Asal. sin descuento jubilatorio. Ingreso de la Ocupación Principal
tabla4.1.3 <- base_individual %>% 
  filter(ESTADO == 1 & CAT_OCUP == 3 & PP07H == 2) %>% 
  group_by(Sexo) %>% 
  summarise(Media.IOP = round(weighted.mean(P21, PONDIIO), 1)) %>% 
  spread(., Sexo, Media.IOP) %>% 
  mutate(Población = "Asalariadas/os sin desc. jubil.",
         Ingreso = "Ingreso de la Ocupación Principal")

tabla4.1 <- bind_rows(tabla4.1.1, tabla4.1.2, tabla4.1.3) %>% 
  mutate(Brecha = percent(((Varones-Mujeres)/Varones), 1),
         Mujeres = formato_pesos(Mujeres),
         Varones = formato_pesos(Varones)) %>% 
  select(Población, Ingreso, Mujeres, Varones, Brecha)
```

__Cuadro 3.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
cuadro3 <- kable(tabla4.1, align = 'llrrr', 
      caption = paste("Brechas de ingresos mensuales. ", date)) %>%
  kable_styling(bootstrap_options = c("striped"), 
                full_width = F, position = "left") %>%
  add_header_above(c(" " = 2, "Media del ingreso" = 2, " " = 1)) %>% 
  footnote(general = "Natsumi Shokida en base a EPH-INDEC",
           general_title = "Fuente: ",
           title_format = c("italic"),
           footnote_as_chunk = FALSE) %>% 
  column_spec(2, width = "6cm") %>% 
  column_spec(5, bold = TRUE, width = "2cm")

cuadro3
```

### Brecha de ingresos mensuales por calificación del puesto de trabajo

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla5.1 <- base_individual %>% 
  filter(CALIFICACION != "0",
         ESTADO == 1) %>% 
  group_by(Sexo, CALIFICACION) %>% 
  summarise(IOP_mensual  = round(weighted.mean(P21, PONDIIO), 2)) 
```

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla5.1_graf <- tabla5.1 %>% 
  spread(., Sexo, IOP_mensual) %>% 
  mutate(brecha = paste0(formato_porc((Varones-Mujeres)/Varones*100), "%"),
         x = (Varones+Mujeres)/2)
```

__Gráfico 4.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(tabla5.1_graf, 
       aes(x = Mujeres, xend = Varones, y = CALIFICACION, 
           group = CALIFICACION, label = brecha)) +
  geom_dumbbell(color = "#808080",
                size_x = 3, size_xend = 3,
                colour_x = colores[1],
                colour_xend = colores[2]) +
  geom_text(data = tabla5.1_graf, 
            aes(x, CALIFICACION, label = brecha), nudge_y = .2)+
  labs(title = "Brecha de ingresos mensuales de la ocupación principal
       por sexo y calificación ocupacional",
       subtitle = paste0("Ocupadas/os. Total de aglomerados urbanos. ", date),
       x = "Ingreso Mensual",
       y = NULL, 
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC")+
  scale_color_manual(values = colores)+
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Aquí hay que cambiar el directorio en que se va a guardar el gráfico.
ggsave("Grafico4.png", scale = 0.7, dpi = 300, width = 10, height = 7)
```

### Brecha de ingresos mensuales por nivel educativo 

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla6.1 <- base_individual %>% 
  filter(ESTADO == 1, !is.na(NIVEL_EDUCATIVO)) %>% 
  group_by(Sexo) %>%
  mutate(Frecuencia = sum(PONDERA)) %>% 
  group_by(Sexo, NIVEL_EDUCATIVO) %>% 
  summarise(Tasa = percent(sum(PONDERA)/unique(Frecuencia), 1)) %>% 
  spread(., Sexo, Tasa) %>% 
  rename("Nivel Educativo" = NIVEL_EDUCATIVO) 

tabla6.2 <- base_individual %>% 
  filter(ESTADO == 1, 
         !is.na(NIVEL_EDUCATIVO)) %>% 
  group_by(Sexo, NIVEL_EDUCATIVO) %>% 
  summarise(IOP_mensual  = round(weighted.mean(P21, PONDIIO), 2)) 
```

__Cuadro 4.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
cuadro4 <- tabla6.1 %>% 
  mutate(Mujeres = color_tile("#FFE6EE", "#FE1764")((Mujeres)),
         Varones = color_tile("#E6FCFF", "#00BDD6")((Varones))) %>% 
  select('Nivel Educativo', Mujeres, Varones) %>% 
  kable(escape = FALSE, digits = 1, align = 'lrr',
        caption = paste("Mujeres y Varones según nivel educativo. Porcentaje por columnas. Ocupadas/os. Total de aglomerados urbanos. ", date)) %>% 
  kable_styling(full_width = F, position = "left") %>% 
  footnote(general = "Natsumi Shokida en base a EPH-INDEC",
           general_title = "Fuente: ",
           title_format = c("italic"),
           footnote_as_chunk = FALSE) %>% 
  column_spec(1, width = "7cm") %>% 
  column_spec(2, color = "black", width = "4cm") %>% 
  column_spec(3, color = "black", width = "4cm")

cuadro4
```

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla6.2_graf <- tabla6.2 %>% 
  spread(., Sexo, IOP_mensual) %>% 
  mutate(brecha = paste0(formato_porc((Varones-Mujeres)/Varones*100), "%"),
         x = (Varones+Mujeres)/2)  
```

__Gráfico 5.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(tabla6.2_graf, 
       aes(x = Mujeres, xend = Varones, y = NIVEL_EDUCATIVO, 
           group = NIVEL_EDUCATIVO, label = brecha)) +
  geom_dumbbell(color = "#808080",
                size_x = 3, size_xend = 3,
                colour_x = colores[1],
                colour_xend = colores[2]) +
  geom_text(data = tabla6.2_graf, 
            aes(x, NIVEL_EDUCATIVO, label = brecha), nudge_y = .2) +
  labs(title = "Brecha de ingresos mensuales de la ocupación principal
       por sexo y nivel educativo",
       subtitle = paste0("Ocupadas/os. Total de aglomerados urbanos. ", date),
       x = "Ingreso Mensual",
       y = NULL, 
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC")+
  scale_color_manual(values = colores)+
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Aquí hay que cambiar el directorio en que se va a guardar el gráfico.
ggsave("Grafico5.png", scale = 0.7, dpi = 300, width = 10, height = 7)
```

## Brechas de ingresos horarios

```{r message=FALSE, warning=FALSE, include=FALSE}
# Ocupades. Ingreso de la Ocupación Principal
tabla7.1.1 <- base_individual %>% 
  filter(ESTADO == 1,
         PP3E_TOT > 0, # Horas trabajadas positivas
         PP3E_TOT != 999) %>% 
  group_by(Sexo) %>% 
  summarise(IOP_hr = round(weighted.mean(P21/(PP3E_TOT * 30 / 7), PONDIIO), 2)) %>% 
  spread(., Sexo, IOP_hr) %>% 
  mutate(Población = "Ocupadas/os")

# Asalariades. Ingreso de la Ocupación Principal
tabla7.1.2 <- base_individual %>% 
  filter(ESTADO == 1,
         CAT_OCUP == 3,
         PP3E_TOT > 0, # Horas trabajadas positivas
         PP3E_TOT != 999) %>% 
  group_by(Sexo) %>% 
  summarise(IOP_hr = round(weighted.mean(P21/(PP3E_TOT * 30 / 7), PONDIIO), 2)) %>% 
  spread(., Sexo, IOP_hr) %>% 
  mutate(Población = "Asalariadas/os")

# Asal. sin descuento jubilatorio. Ingreso de la Ocupación Principal
tabla7.1.3 <- base_individual %>% 
  filter(ESTADO == 1, 
         CAT_OCUP == 3,
         PP07H == 2,
         PP3E_TOT > 0, # Horas trabajadas positivas
         PP3E_TOT != 999) %>% 
  group_by(Sexo) %>% 
  summarise(IOP_hr = round(weighted.mean(P21/(PP3E_TOT * 30 / 7), PONDIIO), 2)) %>% 
  spread(., Sexo, IOP_hr) %>% 
  mutate(Población = "Asalariadas/os sin desc. jubil.")

tabla7.1 <- bind_rows(tabla7.1.1, tabla7.1.2, tabla7.1.3) %>% 
  mutate(Brecha = percent(((Varones-Mujeres)/Varones), 1),
         Mujeres = formato_pesos(Mujeres),
         Varones = formato_pesos(Varones)) %>% 
  select(Población, Mujeres, Varones, Brecha)
```

__Cuadro 5.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
cuadro5 <- kable(tabla7.1, digits = 1, align = 'lrrr', 
      caption = paste("Brechas de ingresos horarios. ", date)) %>%
  kable_styling(bootstrap_options = c("striped"), 
                full_width = F, position = "left") %>%
  add_header_above(c(" " = 1, "Media del ingreso horario" = 2, " " = 1)) %>% 
  footnote(general = "Natsumi Shokida en base a EPH-INDEC",
           general_title = "Fuente: ",
           title_format = c("italic"),
           footnote_as_chunk = FALSE) %>% 
  column_spec(1, width = "7cm") %>% 
  column_spec(4, bold = TRUE, width = "2cm") 

cuadro5
```

### Brecha de ingresos horarios por calificación del puesto de trabajo

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla7.1 <- base_individual %>% 
  filter(CALIFICACION != "0",
         ESTADO == 1, 
         PP3E_TOT > 0,
         PP3E_TOT != 999) %>% 
  group_by(Sexo, CALIFICACION) %>% 
  summarise(IOP_hr = round(weighted.mean(P21/(PP3E_TOT * 30 / 7), PONDIIO), 2),
            IOP_mensual  = round(weighted.mean(P21, PONDIIO), 2))

tabla7.1_graf <- tabla7.1 %>% 
  select(-IOP_mensual) %>% 
  spread(., Sexo, IOP_hr) %>% 
  mutate(brecha = paste0(formato_porc((Varones-Mujeres)/Varones*100), "%"),
         x = (Varones+Mujeres)/2)
```

__Gráfico 6.__ 
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(tabla7.1_graf, 
       aes(x = Mujeres, xend = Varones, y = CALIFICACION, 
           group = CALIFICACION, label = brecha)) +
  geom_dumbbell(color= "#808080",
                size_x = 3, size_xend = 3,
                colour_x = colores[1],
                colour_xend = colores[2]) +
  geom_text(data = tabla7.1_graf,
            aes(x, CALIFICACION, label = brecha), nudge_y = .2)+
  labs(title = "Brecha de ingresos horarios de la ocupación principal
       por sexo y calificación ocupacional",
       subtitle = paste0("Ocupadas/os. Total de aglomerados urbanos. ", date),
       x="Ingreso Mensual",
       y=NULL, 
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC")+
  scale_color_manual(values = colores)+
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Aquí hay que cambiar el directorio en que se va a guardar el gráfico.
ggsave("Grafico6.png", scale = 0.7, dpi = 300, width = 10, height = 7)
```

### Brecha de ingresos horarios por nivel educativo

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla8.2 <- base_individual %>% 
  filter(ESTADO == 1, 
         PP3E_TOT > 0,
         PP3E_TOT != 999,
         !is.na(NIVEL_EDUCATIVO)) %>% 
  group_by(Sexo, NIVEL_EDUCATIVO) %>% 
  summarise(IOP_hr = round(weighted.mean(P21/(PP3E_TOT * 30 / 7), PONDIIO), 2),
            IOP_mensual  = round(weighted.mean(P21, PONDIIO), 2))

tabla8.2_graf <- tabla8.2 %>% 
  select(-IOP_mensual) %>% 
  spread(., Sexo, IOP_hr) %>% 
  mutate(brecha = paste0(formato_porc((Varones-Mujeres)/Varones*100), "%"),
         x = (Varones+Mujeres)/2)
```

__Gráfico 7.__ 
```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(tabla8.2_graf, 
       aes(x = Mujeres, xend = Varones, y = NIVEL_EDUCATIVO, 
           group = NIVEL_EDUCATIVO, label = brecha)) +
  geom_dumbbell(color= "#808080",
                size_x = 3, size_xend = 3,
                colour_x = colores[1],
                colour_xend = colores[2]) +
  geom_text(data = tabla8.2_graf,
            aes(x, NIVEL_EDUCATIVO, label = brecha), nudge_y = .2)+
  labs(title = "Brecha de ingresos horarios de la ocupación principal
       por sexo y nivel educativo",
       subtitle = paste0("Ocupadas/os. Total de aglomerados urbanos. ", date),
       x="Ingreso Mensual",
       y=NULL, 
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC")+
  scale_color_manual(values = colores)+
  theme_minimal()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Aquí hay que cambiar el directorio en que se va a guardar el gráfico.
ggsave("Grafico7.png", scale = 0.7, dpi = 300, width = 10, height = 7)
```

## Horas trabajadas

horas promedio trabajadas para ocupades, asalariades, asalariades no registrades

```{r message=FALSE, warning=FALSE, include=FALSE}
# Ocupades
tabla8.1.1 <- base_individual %>% 
  filter(ESTADO == 1,
         PP3E_TOT > 0, # Horas trabajadas positivas
         PP3E_TOT != 999) %>% 
  group_by(Sexo) %>% 
  summarise(Horas = round(weighted.mean(PP3E_TOT, PONDERA), 1)) %>% 
  spread(., Sexo, Horas) %>% 
  mutate(Población = "Ocupadas/os")

# Asalariades
tabla8.1.2 <- base_individual %>% 
  filter(ESTADO == 1,
         CAT_OCUP == 3,
         PP3E_TOT > 0, # Horas trabajadas positivas
         PP3E_TOT != 999) %>% 
  group_by(Sexo) %>% 
  summarise(Horas = round(weighted.mean(PP3E_TOT, PONDERA), 1)) %>% 
  spread(., Sexo, Horas) %>% 
  mutate(Población = "Asalariadas/os")

# Asal. sin descuento jubilatorio
tabla8.1.3 <- base_individual %>% 
  filter(ESTADO == 1, 
         CAT_OCUP == 3,
         PP07H == 2,
         PP3E_TOT > 0, # Horas trabajadas positivas
         PP3E_TOT != 999) %>% 
  group_by(Sexo) %>% 
  summarise(Horas = round(weighted.mean(PP3E_TOT, PONDERA), 1)) %>% 
  spread(., Sexo, Horas) %>%
  mutate(Población = "Asalariadas/os sin desc. jubil.")

tabla8.1 <- bind_rows(tabla8.1.1, tabla8.1.2, tabla8.1.3) %>% 
  mutate(Brecha = percent(((Varones-Mujeres)/Varones), 1),
         Mujeres = (Mujeres),
         Varones = (Varones)) %>% 
  select(Población, Mujeres, Varones, Brecha)
```

__Cuadro 6.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
cuadro6 <- kable(tabla8.1, digits = 1, align = 'lrrr', 
      caption = paste("Brechas de horas trabajadas. ", date)) %>%
  kable_styling(bootstrap_options = c("striped"), 
                full_width = F, position = "left") %>%
  add_header_above(c(" " = 1, "Horas semanales (media)" = 2, " " = 1)) %>% 
  footnote(general = "Natsumi Shokida en base a EPH-INDEC",
           general_title = "Fuente: ",
           title_format = c("italic"),
           footnote_as_chunk = FALSE) %>% 
  column_spec(1, width = "7cm") %>% 
  column_spec(4, bold = TRUE, width = "2cm") 

cuadro6
```

## Ramas

```{r message=FALSE, warning=FALSE, include=FALSE}
source("funciones rama.R")
```

Ocupadas/os

```{r echo=FALSE, message=FALSE, warning=FALSE}
# ramas de ocupades, con tasa de feminización, ingreso promedio
# tabla9.1 <- base_individual %>% 
#   mutate(Rama = entra.cuchillo.salen.las.ramas(PP04B_COD)) %>% 
#   filter(ESTADO == 1) %>% 
#   group_by(Rama) %>% 
#   summarise(Feminización = percent(sum(PONDERA[Sexo == "Mujeres"])/sum(PONDERA), 1),
#             Ingreso = round(weighted.mean(P21, PONDIIO))) %>% 
#   arrange(Ingreso)
  
# tabla9.1

tabla9.1 <- base_individual %>% 
  mutate(Rama = entra.cuchillo.salen.las.ramas(PP04B_COD)) %>% 
  filter(ESTADO == 1) %>% 
  group_by(Rama) %>% 
  summarise("Tasa de feminización" = percent(sum(PONDERA[Sexo == "Mujeres"])/sum(PONDERA), 1),
            ingreso_promedio = weighted.mean(P21, PONDIIO),
            mujeres = round(weighted.mean(P21[Sexo == "Mujeres"], PONDIIO[Sexo == "Mujeres"])),
            varones = round(weighted.mean(P21[Sexo == "Varones"], PONDIIO[Sexo == "Varones"])),
            brecha_ing_mens = percent(((varones-mujeres)/varones), 1),) %>% 
  arrange(-ingreso_promedio) %>% 
  mutate("Ingreso mensual promedio" = formato_pesos(ingreso_promedio),
         "Brecha ingreso mensual" = brecha_ing_mens) %>% 
  select(-(3:6))
```

__Cuadro 7.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
cuadro7 <- kable(tabla9.1, align = 'llrrr', 
      caption = paste("Ramas de ocupación. Tasa de feminización. Ingreso mensual promedio. ", date)) %>%
  kable_styling(bootstrap_options = c("striped"), 
                full_width = F, position = "left") %>%
#  add_header_above(c(" " = 2, "Media del ingreso" = 2, " " = 1)) %>% 
  footnote(general = "Natsumi Shokida en base a EPH-INDEC",
           general_title = "Fuente: ",
           title_format = c("italic"),
           footnote_as_chunk = FALSE) %>% 
  column_spec(2, width = "6cm") #%>% 
#  column_spec(5, bold = TRUE, width = "2cm")

cuadro7
```

Asalariadas/os

```{r message=FALSE, warning=FALSE, include=FALSE}
# asalariades
# tabla9.2 <- base_individual %>% 
#   mutate(rama = entra.cuchillo.salen.las.ramas(PP04B_COD)) %>% 
#   filter(ESTADO == 1,
#          CAT_OCUP == 3) %>% 
#   group_by(rama) %>% 
#   summarise(Feminización = percent(sum(PONDERA[Sexo == "Mujeres"])/sum(PONDERA), 1),
#             "Sin descuento jubilatorio" = percent(sum(PONDERA[PP07H==2])/sum(PONDERA), 1),
#             "Ingreso Medio" = round(weighted.mean(P21, PONDIIO)),
#             Mujeres = round(weighted.mean(P21[Sexo == "Mujeres"], PONDIIO[Sexo == "Mujeres"])),
#             Varones = round(weighted.mean(P21[Sexo == "Varones"], PONDIIO[Sexo == "Varones"])),
#             Brecha = percent(((Varones-Mujeres)/Varones), 1),) %>% 
#   arrange(-Feminización)

asalariades <- base_individual %>% 
  filter(ESTADO == 1,
         CAT_OCUP == 3) %>% 
  mutate(rama = entra.cuchillo.salen.las.ramas(PP04B_COD),
         total = sum(PONDERA),
         total_mujeres = sum(PONDERA[Sexo == "Mujeres"]),
         total_varones = sum(PONDERA[Sexo == "Varones"]))

asal.ramas <- asalariades %>% 
  group_by(rama) %>% 
  summarise(prop_en_mujeres = round(sum(PONDERA[Sexo == "Mujeres"])/unique(total_mujeres)*100, 1),
            prop_en_varones = round(sum(PONDERA[Sexo == "Varones"])/unique(total_varones)*100, 1),
            tasa_feminizacion = round(sum(PONDERA[Sexo == "Mujeres"])/sum(PONDERA)*100, 1),
            tasa_no_registro = round(sum(PONDERA[PP07H == 2])/sum(PONDERA)*100, 1),
            ingreso_mensual = weighted.mean(P21, PONDIIO),
            Mujeres = round(weighted.mean(P21[Sexo == "Mujeres"], PONDIIO[Sexo == "Mujeres"])),
            Varones = round(weighted.mean(P21[Sexo == "Varones"], PONDIIO[Sexo == "Varones"])),
            brecha_ing_mens = percent(((Varones-Mujeres)/Varones), 1),) %>% 
#  summarise(Feminización = percent(sum(PONDERA[Sexo == "Mujeres"])/sum(PONDERA), 1),
#            "Sin descuento jubilatorio" = percent(sum(PONDERA[PP07H==2])/sum(PONDERA), 1),
#            "Ingreso Medio" = round(weighted.mean(P21, PONDIIO)),
#            Mujeres = round(weighted.mean(P21[Sexo == "Mujeres"], PONDIIO[Sexo == "Mujeres"])),
#            Varones = round(weighted.mean(P21[Sexo == "Varones"], PONDIIO[Sexo == "Varones"])),
#            Brecha = percent(((Varones-Mujeres)/Varones), 1),) %>% 
  arrange(-tasa_feminizacion)

asal.ramas2 <- asalariades %>% 
  filter(PP3E_TOT > 0, # Horas trabajadas positivas
         PP3E_TOT != 999) %>% 
  group_by(Sexo, rama) %>% 
  summarise(iop_hr = round(weighted.mean(P21/(PP3E_TOT * 30 / 7), PONDIIO), 2)) %>% 
  group_by(rama) %>% 
  summarise(Mujeres = iop_hr[Sexo == "Mujeres"],
            Varones = iop_hr[Sexo == "Varones"],
            brecha_ing_hr = percent(((Varones-Mujeres)/Varones), 1),)

tabla9.2 <- asal.ramas %>% 
  left_join(., asal.ramas2, by = "rama")

rm(asal.ramas, asal.ramas2)

# Luego sección de ramas:

# ramas de asalariades, con tasa de fem, tasa de no reg, con ingreso (muj, var, brecha), con horas (muj, var, brecha)

# Luego distribución de las tareas del hogar (con referencia a la reproducción de los mismos estereotipos que en ramas). Mención de Servicio doméstico. Distribución del ingreso
```

<br>

## Distribución de las tareas del hogar

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla11.1_graf <- base_individual %>% 
  left_join(., base_hogar %>% 
              select(CODUSU, NRO_HOGAR, VII1_1, VII1_2), by = c("CODUSU", "NRO_HOGAR")) %>% 
  mutate(proporcion = case_when(VII1_1 == COMPONENTE | VII1_2 == COMPONENTE ~ 1,
                                    TRUE ~ 0)) %>% 
  select(Sexo, proporcion, PONDERA) %>% 
  group_by(Sexo) %>% 
    summarise(proporcion = sum(proporcion*PONDERA)) %>% 
    mutate(proporcion = round(proporcion/sum(proporcion)*100, 0))
```

__Gráfico 8.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
## Prep data (nothing to change here)
nrows <- 10
df <- expand.grid(x = 1:nrows, y = 1:nrows)
df$Sexo <- factor(rep(tabla11.1_graf$Sexo, tabla11.1_graf$proporcion))  
## Plot
ggplot(df, aes(x = x, y = y, fill = Sexo)) + 
  geom_tile(color = "black", size = 0.5) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), trans = 'reverse') +
  scale_fill_manual(values = colores) +
  labs(title = "Personas que realizan las tareas domésticas del hogar por sexo",
       subtitle = paste0("No incluye trabajadoras de servicio doméstico. Total de aglomerados urbanos. ", date),
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC") +
  theme_void()
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#ggsave("Graficos/Grafico8.png", scale = 3)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
tabla9.1 <- base_individual %>% 
  filter(PP04B1 == 1) %>% 
  mutate(Total = sum(PONDERA)) %>% 
  group_by(Sexo) %>% 
  summarise(Proporcion = formato_porc(sum(PONDERA)/unique(Total)*100))

tabla9.2_graf <- base_individual %>% 
  filter(ESTADO == 1,
         Sexo == "Mujeres") %>% 
  mutate(servicio.domestico = case_when(PP04B1 == 1 ~ "Sí",
                                          PP04B1 != 1 ~ "No")) %>% 
  group_by(servicio.domestico) %>% 
  summarise(frecuencia = sum(PONDERA)) %>% 
  mutate(proporcion = round(frecuencia/sum(frecuencia)*100, 0))
```

__Gráfico 9.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
colores2 = c("#FE1764","#808080")

## Prep data (nothing to change here)
nrows <- 10
df <- expand.grid(x = 1:nrows, y = 1:nrows)
df$servicio.domestico <- factor(rep(tabla9.2_graf$servicio.domestico, tabla9.2_graf$proporcion))  
## Plot
ggplot(df, aes(x = x, y = y, fill = servicio.domestico)) + 
  geom_tile(color = "black", size = 0.5) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0), trans = 'reverse') +
  scale_fill_manual(values = colores2) +
  guides(fill=guide_legend(title="Trabajan en Servicio Doméstico?")) +
  labs(title = "Ocupadas, según si prestan o no servicios domésticos en hogares particulares",
       subtitle = paste0("Total de aglomerados urbanos. ", date),
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC") +
  theme_void()
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#ggsave("Graficos/Grafico9.png", scale = 3)
```

<br>

## Distribución del ingreso
         
__Gráfico 10.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
tabla13.1_graf <-base_individual %>% 
  select(DECCFR, IPCF, PONDIH, Sexo) %>% 
  filter(DECCFR %in% c(1:10)) %>% 
  group_by(DECCFR) %>% 
  mutate(Pob = sum(PONDIH)) %>% 
  group_by(DECCFR, Sexo) %>%
  summarise(Prop = sum(PONDIH)/unique(Pob))

ggplot(tabla13.1_graf, aes(x = DECCFR, Prop, fill = Sexo, group= Sexo, label = paste0(formato_porc(Prop*100), "%"))) +
  geom_col(position = "dodge") +
  geom_text(position = position_dodge(width = .9), vjust =-.1, size = 2.5) +
  labs(y = '') +
  scale_fill_manual(values = colores) +
  scale_x_continuous("Decil del Ingreso Per Cápita Familiar", breaks = c(1:10)) +
  labs(title = "Total de la población",
       subtitle = paste0("Composición según sexo de los deciles del ingreso per cápita familiar. Total de aglomerados urbanos. ", date),
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC") +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
```
             
```{r, echo=FALSE, message=FALSE, warning=FALSE}
#ggsave("Graficos/Grafico10.png", scale = 1)
```

__Gráfico 11.__
```{r echo=FALSE, message=FALSE, warning=FALSE}
tabla12.1_graf <-base_individual %>% 
    select(DECINDR, P47T, PONDII, Sexo) %>% 
    filter(DECINDR %in% c(1:10)) %>% 
  group_by(DECINDR) %>% 
  mutate(Pob = sum(PONDII)) %>% 
  group_by(DECINDR, Sexo) %>%
  summarise(Prop = sum(PONDII)/unique(Pob))

ggplot(tabla12.1_graf, aes(x = DECINDR, Prop, fill = Sexo, group= Sexo, label = paste0(formato_porc(Prop*100), "%"))) +
  geom_col(position = "dodge")+
  geom_text(position = position_dodge(width = .9), vjust =-.1, size = 2.5)+
  theme_minimal()+
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(y = '') +
  scale_fill_manual(values = colores)+
  scale_x_continuous("Decil de ingreso total", breaks =c(1:10)) +
  labs(title = "Población perceptora de ingresos",
       subtitle = paste0("Composición según sexo de los deciles de ingresos totales individuales. Total de aglomerados urbanos. ", date),
       caption = "Fuente: Natsumi Shokida en base a EPH-INDEC")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#ggsave("Graficos/Grafico11.png", scale = 1)
```


[^1]: _Presionando en_  __Code > Download Rmd__ _se accede a la descarga de la sintaxis completa de este informe, que incluye la descarga automática de las bases de la EPH utilizadas, una serie de funciones útiles y la elaboración de cuadros y gráficos con el lenguaje R._    

```{r message=FALSE, warning=FALSE, include=FALSE}
# Brechas de los cuadros antes de las medias y barras de colores
# cuadro 1 con barras de % de colores
```





